# 微信 8.0.64 版本兼容性测试指南

## 🎯 测试目标

1. 验证插件是否能正常加载
2. 检查类和方法是否存在
3. 测试自动回复功能
4. 排查闪退和兼容性问题

---

## 📋 测试步骤

### 阶段 1：基础测试（不会闪退）

#### 1.1 使用安全版本编译

```bash
# 备份原文件
cp src/Tweak.xm src/Tweak_backup.xm

# 使用安全测试版本
cp src/Tweak_Safe.xm src/Tweak.xm

# 编译
make clean && make
```

#### 1.2 注入并安装

```bash
# 注入 dylib 到微信
# 重签名
# 安装到设备
```

#### 1.3 查看启动日志

打开微信后，通过以下方式查看日志：

**方法A：通过 SSH 查看（越狱设备）**
```bash
ssh mobile@设备IP
tail -f /var/log/syslog | grep "WCEnhance\|AutoReply\|Message\|ERROR"
```

**方法B：通过 Xcode Console**
```
Xcode → Window → Devices and Simulators → 选择设备 → Open Console
搜索：WCEnhance
```

**方法C：使用 CrashReporter（越狱设备）**
```bash
# 安装 CrashReporter
# 查看微信崩溃日志
ls /var/mobile/Library/Logs/CrashReporter/ | grep WeChat
```

#### 1.4 预期输出

如果一切正常，应该看到类似日志：

```
========================================
🚀 WCEnhance 插件已加载 [测试版]
========================================
📱 微信版本: 8.0.64 (xxx)
⚙️  iOS 版本: 15.0
📱 设备型号: iPhone
========================================
🔍 检查关键类:
   CMessageMgr: ✅ 存在
   CMessageWrap: ✅ 存在
   CContactMgr: ✅ 存在
   MMServiceCenter: ✅ 存在
========================================
```

**如果看到 ❌ 不存在**：
- 说明微信的类结构已改变
- 需要使用 class-dump 重新分析
- 需要更新代码适配新版本

---

### 阶段 2：功能测试

#### 2.1 测试消息监听

1. 让别人给你发一条消息
2. 查看日志，应该看到：

```
========== [AsyncOnAddMsg] 被调用 ==========
[Message] 类型: 1
[Message] 发送人: wxid_xxxxx
[Message] 接收人: wxid_你的ID
[Message] 内容长度: 10
```

#### 2.2 测试自动回复

1. 在微信设置中开启"自动回复"开关
2. 让别人发送包含关键词的消息，比如"你好"
3. 查看日志：

```
[AutoReply] ========== 开始处理 ==========
[AutoReply] 📨 收到文本消息: 你好
[AutoReply] ✅ 这是别人发给我的消息
[AutoReply] ✅ 匹配到关键词: 你好
[AutoReply] 📤 准备回复: 您好！有什么可以帮助您的吗？😊
[AutoReply] 🚀 发送文本消息...
[Send] ========== 发送文本消息 ==========
[Send] 文本: 您好！有什么可以帮助您的吗？😊
[Send] 接收人: wxid_xxxxx
[Send] ✅ 消息对象创建成功
[Send] ✅ 消息已发送
```

---

## 🐛 常见问题及解决方案

### 问题 1：微信启动后立即闪退

**原因：** 可能某个类或方法不存在

**解决：**
```bash
# 1. 查看崩溃日志
ls -lt /var/mobile/Library/Logs/CrashReporter/ | grep WeChat | head -1

# 2. 查看崩溃原因
cat /var/mobile/Library/Logs/CrashReporter/WeChat-xxx.ips

# 3. 定位到崩溃的方法
# 在日志中搜索 "unrecognized selector" 或 "class not found"
```

**修复：**
- 注释掉对应的 Hook 代码
- 使用 class-dump 查找新的类名/方法名

---

### 问题 2：插件加载但不工作

**症状：** 微信正常运行，但看不到日志输出

**原因：**
1. dylib 没有被注入
2. plist 配置不正确
3. 系统日志被清空

**检查：**
```bash
# 1. 检查 dylib 是否在 app 中
ls -la /var/containers/Bundle/Application/微信目录/WeChat.app/*.dylib

# 2. 检查 plist
cat /var/containers/Bundle/Application/微信目录/WeChat.app/wapleodtcorexpc.plist

# 3. 检查微信二进制是否包含 load 命令
otool -l /var/containers/Bundle/Application/微信目录/WeChat.app/WeChat | grep "wapleodtcorexpc"
```

---

### 问题 3：AsyncOnAddMsg 没有被调用

**症状：** 启动日志正常，但收到消息时没有日志

**原因：** 微信改变了消息接收的方法名

**解决：**
```bash
# 1. 使用 Frida 动态分析
frida -U -n WeChat

# 2. 在 Frida 中执行
var classes = ObjC.enumerateLoadedClasses();
for (var i = 0; i < classes.length; i++) {
    if (/message/i.test(classes[i])) {
        console.log(classes[i]);
    }
}

# 3. Hook 找到的类，查看方法调用
var CMessageMgr = ObjC.classes.CMessageMgr;
if (CMessageMgr) {
    Interceptor.attach(CMessageMgr["- AsyncOnAddMsg:MsgWrap:"].implementation, {
        onEnter: function(args) {
            console.log("AsyncOnAddMsg 被调用");
        }
    });
}
```

---

### 问题 4：消息发送失败

**症状：** 日志显示"消息已发送"但实际没有发送

**原因：** `AddLocalMsg` 方法可能不再用于发送消息

**解决：**

需要找到新的发送消息方法：

```bash
# 使用 class-dump 查看 CMessageMgr 的方法
class-dump -H WeChat.app/WeChat | grep -A 20 "@interface CMessageMgr"

# 查找可能的发送方法
grep -i "send.*message\|add.*msg" CMessageMgr.h
```

可能的新方法名：
- `SendMessage:MsgWrap:`
- `SendTextMsg:toUser:`
- `addMessage:toSession:`

---

## 🔍 使用 class-dump 更新代码

### 步骤 1：获取新版微信

```bash
# 1. 下载微信 8.0.64 IPA
# 2. 砸壳（如果需要）
# 3. 解压 IPA
unzip WeChat_8.0.64.ipa
```

### 步骤 2：导出头文件

```bash
# 安装 class-dump (macOS)
brew install class-dump

# 导出头文件
class-dump -H Payload/WeChat.app/WeChat -o ~/WeChat_8.0.64_Headers/

# 查看生成的头文件数量
ls ~/WeChat_8.0.64_Headers/ | wc -l
```

### 步骤 3：对比差异

```bash
# 查看消息管理相关的类
cd ~/WeChat_8.0.64_Headers/
ls | grep -i "message"

# 查看 CMessageMgr 的变化
cat CMessageMgr.h | grep -A 5 "AsyncOnAddMsg\|SendMessage\|AddMsg"

# 对比老版本
diff 老版本/CMessageMgr.h 新版本/CMessageMgr.h
```

### 步骤 4：更新代码

根据 class-dump 的结果更新 `WeChatRedEnvelop.h` 和 `Tweak.xm`

---

## 📊 兼容性检查清单

### ✅ 必须检查的项

- [ ] 插件能正常加载（看到启动日志）
- [ ] CMessageMgr 类存在
- [ ] CMessageWrap 类存在
- [ ] AsyncOnAddMsg 方法存在
- [ ] 能接收到消息通知
- [ ] 能创建 CMessageWrap 对象
- [ ] AddLocalMsg 方法存在
- [ ] 能发送文本消息

### ⚠️ 可能需要适配的项

- [ ] 消息类型枚举值是否改变
- [ ] 消息属性名称是否改变
- [ ] 发送消息的方法是否改变
- [ ] 联系人管理类是否改变
- [ ] 红包相关类是否改变

---

## 🛠️ 调试技巧

### 技巧 1：逐步启用功能

```objc
// 第一次测试：只加载，不 Hook
%ctor {
    NSLog(@"插件已加载");
}

// 第二次测试：只 Hook，不处理
%hook CMessageMgr
- (void)AsyncOnAddMsg:(NSString *)msg MsgWrap:(CMessageWrap *)wrap {
    NSLog(@"消息接收");
    %orig;
}
%end

// 第三次测试：加入自动回复
// ...
```

### 技巧 2：使用宏控制调试输出

```objc
#define WCPL_DEBUG 1

#if WCPL_DEBUG
    #define DLog(format, ...) NSLog(@"[DEBUG] " format, ##__VA_ARGS__)
#else
    #define DLog(format, ...)
#endif

// 使用
DLog(@"消息类型: %u", wrap.m_uiMessageType);
```

### 技巧 3：运行时动态检测

```objc
// 检测方法是否存在
if ([self respondsToSelector:@selector(AsyncOnAddMsg:MsgWrap:)]) {
    DLog(@"✅ AsyncOnAddMsg 方法存在");
} else {
    DLog(@"❌ AsyncOnAddMsg 方法不存在");
}

// 检测属性是否存在
if ([wrap respondsToSelector:@selector(m_uiMessageType)]) {
    DLog(@"✅ m_uiMessageType 属性存在");
} else {
    DLog(@"❌ m_uiMessageType 属性不存在");
}
```

---

## 📝 测试报告模板

```
=== 微信插件兼容性测试报告 ===

测试日期：2024-11-01
微信版本：8.0.64 (xxx)
iOS 版本：15.0
设备型号：iPhone 12

【基础功能】
✅ 插件加载成功
✅ 启动日志正常
✅ CMessageMgr 类存在
✅ AsyncOnAddMsg 方法存在

【消息监听】
✅ 能接收到消息通知
✅ 能获取消息内容
✅ 能识别发送人

【自动回复】
❌ 发送消息失败
原因：AddLocalMsg 方法签名改变
需要：查找新的发送方法

【崩溃情况】
无崩溃

【其他问题】
无

【总结】
基本功能正常，但发送消息需要适配新版本API
```

---

## 🔗 有用的资源

- [iOS App Hook 技术](https://iphonedevwiki.net/index.php/Hooking)
- [Theos 文档](https://theos.dev)
- [class-dump 使用](https://github.com/nygard/class-dump)
- [Frida 动态分析](https://frida.re)
- [微信逆向社区](https://iosre.com)

---

## ✅ 测试完成后

如果测试成功：
1. 将 `Tweak_Safe.xm` 的日志部分去掉
2. 重新编译最终版本
3. 记录兼容的微信版本号

如果测试失败：
1. 收集所有日志和崩溃信息
2. 使用 class-dump 分析新版本
3. 更新代码适配新API
4. 重新测试

祝测试顺利！ 🚀

